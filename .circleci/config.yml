version: 2.1

orbs:
  vsp-ci: vector-solutions/vsp-ci@1.13.4
  aws-cli: circleci/aws-cli@5.2.0

# YAML Anchors for reusability
x-main-filters: &main-filters
  branches:
    only: main

x-release-filters: &release-filters
  branches:
    only:
      - main
      - /release\/.*/

x-preview-filters: &preview-filters
  branches:
    ignore:
      - main
      - /release\/.*/

x-core-context: &core-context
  - Vector Core CI

# Pipeline parameters
parameters:
  workspace_dir:
    type: string
    default: /home/circleci/workspace
  checkout_dir:
    type: string
    default: /home/circleci/workspace/project
  source_dir:
    type: string
    default: /home/circleci/workspace/project
  image_dir:
    type: string
    default: /home/circleci/workspace/images
  test_results_dir:
    type: string
    default: /home/circleci/workspace/test-results
  docker_repo_root:
    type: string
    default: teachpoint
  project_name:
    type: string
    default: eval-pd-report-service

# Jobs
jobs:
  build-and-test:
    docker:
      - image: cimg/openjdk:21.0
    resource_class: large
    steps:
      - checkout:
          path: << pipeline.parameters.checkout_dir >>

      - restore_cache:
          keys:
            - maven-deps-v1-{{ checksum "pom.xml" }}
            - maven-deps-v1-

      - run:
          name: Download Maven Dependencies
          working_directory: << pipeline.parameters.source_dir >>
          command: |
            mvn dependency:go-offline -B

      - save_cache:
          paths:
            - ~/.m2
          key: maven-deps-v1-{{ checksum "pom.xml" }}

      - run:
          name: Run Maven Build
          working_directory: << pipeline.parameters.source_dir >>
          command: |
            mvn clean package -DskipTests -B

      - run:
          name: Run Unit Tests with Coverage
          working_directory: << pipeline.parameters.source_dir >>
          command: |
            mkdir -p << pipeline.parameters.test_results_dir >>
            mvn test -B || true
            # Copy test results (non-blocking)
            find . -type f -regex ".*/target/surefire-reports/.*xml" -exec cp {} << pipeline.parameters.test_results_dir >>/ \;

      - run:
          name: Generate JaCoCo Coverage Report
          working_directory: << pipeline.parameters.source_dir >>
          command: |
            mvn jacoco:report -B || true

      - store_test_results:
          path: << pipeline.parameters.test_results_dir >>

      - store_artifacts:
          path: << pipeline.parameters.source_dir >>/target/site/jacoco
          destination: coverage-report

      - store_artifacts:
          path: << pipeline.parameters.test_results_dir >>
          destination: test-results

      - persist_to_workspace:
          root: << pipeline.parameters.workspace_dir >>
          paths:
            - project/target/*.jar
            - project/pom.xml
            - project/src
            - project/docker

  dependency-check:
    docker:
      - image: cimg/openjdk:21.0
    resource_class: medium
    steps:
      - checkout:
          path: << pipeline.parameters.checkout_dir >>

      - attach_workspace:
          at: << pipeline.parameters.workspace_dir >>

      - restore_cache:
          keys:
            - maven-deps-v1-{{ checksum "pom.xml" }}

      - run:
          name: OWASP Dependency Check
          working_directory: << pipeline.parameters.source_dir >>
          command: |
            echo "Running OWASP Dependency Check..."
            mvn org.owasp:dependency-check-maven:check \
              -DfailBuildOnCVSS=7 \
              -DsuppressionsLocation=.circleci/dependency-check-suppressions.xml \
              || echo "Dependency check found vulnerabilities (non-blocking)"

      - store_artifacts:
          path: << pipeline.parameters.source_dir >>/target/dependency-check-report.html
          destination: dependency-check-report

  build-docker-image:
    docker:
      - image: cimg/openjdk:21.0
    resource_class: medium
    steps:
      - checkout:
          path: << pipeline.parameters.checkout_dir >>

      - attach_workspace:
          at: << pipeline.parameters.workspace_dir >>

      - setup_remote_docker:
          version: default
          docker_layer_caching: true

      - run:
          name: Create Image Directory
          command: |
            mkdir -p << pipeline.parameters.image_dir >>

      - run:
          name: Extract Version from pom.xml
          working_directory: << pipeline.parameters.source_dir >>
          command: |
            # Extract version from pom.xml
            VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
            echo "Extracted version: ${VERSION}"
            echo "export VERSION=${VERSION}" >> $BASH_ENV

      - vsp-ci/docker-build-image:
          working_directory: << pipeline.parameters.source_dir >>
          image_directory: << pipeline.parameters.image_dir >>
          project_name: << pipeline.parameters.project_name >>
          project_path: "."
          docker_repo_root: << pipeline.parameters.docker_repo_root >>
          git_branch: << pipeline.git.branch >>

      - persist_to_workspace:
          root: << pipeline.parameters.workspace_dir >>
          paths:
            - images/*.tar

  scan-docker-image:
    docker:
      - image: cimg/base:current
    resource_class: medium
    steps:
      - attach_workspace:
          at: << pipeline.parameters.workspace_dir >>

      - setup_remote_docker:
          version: default

      - vsp-ci/docker-scan-image-veracode:
          image_directory: << pipeline.parameters.image_dir >>
          project_name: << pipeline.parameters.project_name >>
          veracode_api_key_id_var: VECTOR_VERACODE_API_ID
          veracode_api_key_secret_var: VECTOR_VERACODE_API_KEY
          report_mode: "true"
          allowed_critical: 0
          allowed_high: 5
          allowed_medium: -1
          allowed_low: -1

  push-docker-image:
    docker:
      - image: cimg/base:current
    resource_class: small
    steps:
      - checkout:
          path: << pipeline.parameters.checkout_dir >>

      - attach_workspace:
          at: << pipeline.parameters.workspace_dir >>

      - setup_remote_docker:
          version: default

      - vsp-ci/docker-push-image-ecr:
          image_directory: << pipeline.parameters.image_dir >>
          image_name: << pipeline.parameters.project_name >>
          image_namespace: << pipeline.parameters.docker_repo_root >>

  push-docker-image-manual:
    docker:
      - image: cimg/base:current
    resource_class: small
    steps:
      - checkout:
          path: << pipeline.parameters.checkout_dir >>

      - attach_workspace:
          at: << pipeline.parameters.workspace_dir >>

      - setup_remote_docker:
          version: default

      - vsp-ci/docker-push-image-ecr:
          image_directory: << pipeline.parameters.image_dir >>
          image_name: << pipeline.parameters.project_name >>
          image_namespace: << pipeline.parameters.docker_repo_root >>

# Workflows
workflows:
  version: 2

  # Automatic workflow for main and release branches
  build-test-deploy-auto:
    jobs:
      # Build and test (automatic for main/release)
      - build-and-test:
          name: Build and Test (Auto)
          context: *core-context
          filters: *release-filters

      # Dependency scanning (runs on main/release, non-blocking)
      #- dependency-check:
      #    name: Security - Dependency Check
      #    requires:
      #      - Build and Test (Auto)
      #    context: *core-context
      #    filters: *release-filters

      # Build Docker image (automatic for main/release)
      - build-docker-image:
          name: Build Docker Image (Auto)
          requires:
            - Build and Test (Auto)
          context: *core-context
          filters: *release-filters

      # Scan Docker image with Veracode (automatic for main/release)
      - scan-docker-image:
          name: Security - Container Scan (Auto)
          requires:
            - Build Docker Image (Auto)
          context:
            - Vector Core CI
            - VeracodeAgents
          filters: *release-filters

      # Push to ECR (automatic for main and release/* branches)
      - push-docker-image:
          name: Push to ECR (Auto)
          requires:
            - Build Docker Image (Auto)
            - Security - Container Scan (Auto)
          context: *core-context
          filters: *release-filters

  # Manual workflow for feature branches
  build-test-deploy-manual:
    jobs:
      # Manual approval to start pipeline for feature branches
      - hold-for-manual-start:
          name: Hold - Approve to Start Pipeline
          type: approval
          filters: *preview-filters

      # Build and test (manual trigger for feature branches)
      - build-and-test:
          name: Build and Test (Manual)
          requires:
            - Hold - Approve to Start Pipeline
          context: *core-context
          filters: *preview-filters

      # Dependency scanning (manual trigger for feature branches)
      #- dependency-check:
      #    name: Security - Dependency Check (Manual)
      #    requires:
      #      - Build and Test (Manual)
      #    context: *core-context
      #    filters: *preview-filters

      # Build Docker image (after manual approval)
      - build-docker-image:
          name: Build Docker Image (Manual)
          requires:
            - Build and Test (Manual)
          context: *core-context
          filters: *preview-filters

      # Scan Docker image with Veracode (after manual approval)
      - scan-docker-image:
          name: Security - Container Scan (Manual)
          requires:
            - Build Docker Image (Manual)
          context:
            - Vector Core CI
            - VeracodeAgents
          filters: *preview-filters

      # Manual approval to push from feature branches
      - hold-for-manual-push:
          name: Hold - Approve to Push to ECR
          type: approval
          requires:
            - Build Docker Image (Manual)
            - Security - Container Scan (Manual)
          filters: *preview-filters

      # Push to ECR (manual approval for feature branches)
      - push-docker-image-manual:
          name: Push to ECR (Manual)
          requires:
            - Hold - Approve to Push to ECR
          context: *core-context
          filters: *preview-filters
