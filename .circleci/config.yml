version: 2.1

setup: true

orbs:
  path-filtering: circleci/path-filtering@1.1.0

workflows:
  setup-workflow:
    jobs:
      - path-filtering/filter:
          debug: false
          name: detect-changed-paths
          base-revision: main
          config-path: .circleci/shared/base.yaml
          exclude: |
            # Exclude all paths that are not relevant to the dynamic configuration
            README.md
            docs/.*
            .gitignore
          mapping: |
            # Always include base config
            .* .circleci/shared/base.yaml
            # Source code changes trigger build pipeline
            src/main/.* .circleci/shared/config-build.yaml
            src/test/.* .circleci/shared/config-build.yaml
            pom.xml .circleci/shared/config-build.yaml
            Dockerfile .circleci/shared/config-build.yaml
            docker/.* .circleci/shared/config-build.yaml
            # Helm chart changes trigger GitOps promotions
            src/helm/eval-pd-report-service/.* .circleci/shared/config-chart.yaml
            # GitOps promotion file changes (auto_merge based on environment)
            gitops-promotions/.*/nonprod.* auto_merge_pr true .circleci/shared/config-gitops-promotions.yaml
            gitops-promotions/.*/prod.* auto_merge_pr false .circleci/shared/config-gitops-promotions.yaml
          filters:
            branches:
              ignore:
                - hydrated-manifests
                - /^promote\/.*/
