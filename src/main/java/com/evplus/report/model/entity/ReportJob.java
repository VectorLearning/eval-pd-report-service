package com.evplus.report.model.entity;

import com.evplus.report.model.enums.ReportStatus;
import com.evplus.report.model.enums.ReportType;
import jakarta.persistence.*;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.time.LocalDateTime;

/**
 * JPA Entity for report generation job tracking.
 * Maps to the 'reportjobs' table in the database.
 * Tracks both synchronous and asynchronous report generation requests.
 */
@Entity
@Table(name = "reportjobs")
@Data
@NoArgsConstructor
@AllArgsConstructor
public class ReportJob {

    /**
     * Unique identifier for the report job (UUID format).
     * Primary key.
     */
    @Id
    @Column(name = "report_id", length = 36, nullable = false)
    private String reportId;

    /**
     * District ID for authorization and data filtering.
     */
    @Column(name = "district_id", nullable = false)
    private Integer districtId;

    /**
     * User ID who requested the report.
     */
    @Column(name = "user_id", nullable = false)
    private Integer userId;

    /**
     * Type of report being generated.
     */
    @Enumerated(EnumType.STRING)
    @Column(name = "report_type", length = 50, nullable = false)
    private ReportType reportType;

    /**
     * JSON string containing report criteria and filters.
     * Stored as TEXT to support large filter sets.
     */
    @Column(name = "report_params", columnDefinition = "TEXT")
    private String reportParams;

    /**
     * Current status of the report job.
     * Stored as integer in database for backward compatibility.
     */
    @Column(name = "status", nullable = false)
    private Integer statusCode = 0;

    /**
     * Timestamp when the report was requested.
     */
    @Column(name = "requested_date", nullable = false)
    private LocalDateTime requestedDate;

    /**
     * Timestamp when processing started (null if not yet started).
     */
    @Column(name = "started_date")
    private LocalDateTime startedDate;

    /**
     * Timestamp when processing completed or failed (null if still processing).
     */
    @Column(name = "completed_date")
    private LocalDateTime completedDate;

    /**
     * Presigned S3 URL for report download (null until completed).
     */
    @Column(name = "s3_url", length = 500)
    private String s3Url;

    /**
     * Generated filename for the report (null until completed).
     */
    @Column(name = "filename")
    private String filename;

    /**
     * Error message if status is FAILED (null otherwise).
     */
    @Column(name = "error_message", columnDefinition = "TEXT")
    private String errorMessage;

    /**
     * Record creation timestamp (auto-generated by database).
     */
    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;

    /**
     * Record last update timestamp (auto-updated by database).
     */
    @Column(name = "updated_at", nullable = false)
    private LocalDateTime updatedAt;

    /**
     * Get the status as an enum for type-safe operations.
     * @return ReportStatus enum
     */
    @Transient
    public ReportStatus getStatus() {
        return statusCode != null ? ReportStatus.fromValue(statusCode) : null;
    }

    /**
     * Set the status using the enum.
     * @param status ReportStatus enum value
     */
    @Transient
    public void setStatus(ReportStatus status) {
        this.statusCode = status != null ? status.getValue() : null;
    }

    /**
     * JPA lifecycle callback to set timestamps before insert.
     */
    @PrePersist
    protected void onCreate() {
        LocalDateTime now = LocalDateTime.now();
        if (createdAt == null) {
            createdAt = now;
        }
        if (updatedAt == null) {
            updatedAt = now;
        }
        if (requestedDate == null) {
            requestedDate = now;
        }
    }

    /**
     * JPA lifecycle callback to update timestamp before update.
     */
    @PreUpdate
    protected void onUpdate() {
        updatedAt = LocalDateTime.now();
    }
}
